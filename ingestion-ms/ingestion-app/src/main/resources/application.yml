spring:
  config:
    import: "optional:configtree:/run/secrets/"
  application:
    name: ingestion-ms

  datasource:
    main:
      url: "jdbc:postgresql://${DB_HOST:localhost}:${DATABASE_PORT:5432}/${DATABASE_NAME:sovereignrag_master}?ApplicationName=${spring.application.name}&reWriteBatchedInserts=true&prepareThreshold=1&preferQueryMode=extended"
      username: "${sovereignrag_db_user:sovereignrag}"
      password: "${sovereignrag_db_password:RespectTheHangover}"
      driver-class-name: org.postgresql.Driver
      hikari:
        data-source-properties:
          cachePrepStmts: true
          prepStmtCacheSize: 250
          prepStmtCacheSqlLimit: 2048
          useServerPrepStmts: true
          useLocalSessionState: true
          rewriteBatchedStatements: true
          cacheResultSetMetadata: true
          cacheServerConfiguration: true
          elideSetAutoCommits: true
          maintainTimeStats: false
          application: ${spring.application.name}
          tcpKeepAlive: true
          socketTimeout: 30
          prepareThreshold: 1
          preferQueryMode: extended
          stringtype: unspecified
        maximum-pool-size: 10
        minimum-idle: 3
        schema: ingestion
        register-mbeans: false
        pool-name: "ingestion"
        connectionTimeout: 30000
        idleTimeout: 300000
        maxLifetime: 1800000
        leakDetectionThreshold: 60000
        validationTimeout: 5000
        connectionTestQuery: "SELECT 1"
        initializationFailTimeout: 30000
    read-replica:
      url: "jdbc:postgresql://${READ_REPLICA_DB_HOST:${DB_HOST:localhost}}:${READ_REPLICA_DATABASE_PORT:${DATABASE_PORT:5432}}/${READ_REPLICA_DATABASE_NAME:sovereignrag_master}?ApplicationName=${spring.application.name}&reWriteBatchedInserts=true"
      username: "${sovereignrag_db_user:sovereignrag}"
      password: "${sovereignrag_db_password:RespectTheHangover}"
      driver-class-name: org.postgresql.Driver
      hikari:
        data-source-properties:
          cachePrepStmts: true
          prepStmtCacheSize: 200
          prepStmtCacheSqlLimit: 2048
          useServerPrepStmts: true
          useLocalSessionState: true
          rewriteBatchedStatements: true
          cacheResultSetMetadata: true
          cacheServerConfiguration: true
          elideSetAutoCommits: true
          maintainTimeStats: false
          application: ${spring.application.name}
          tcpKeepAlive: true
          socketTimeout: 30
        maximum-pool-size: 6
        minimum-idle: 1
        schema: ingestion
        register-mbeans: false
        pool-name: "ingestion-replica"
        connectionTimeout: 30000
        idleTimeout: 300000
        maxLifetime: 1800000
        leakDetectionThreshold: 60000
        validationTimeout: 5000
        connectionTestQuery: "SELECT 1"
        initializationFailTimeout: 30000

  jpa:
    hibernate:
      ddl-auto: validate
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true
        default_schema: ingestion
    show-sql: false

  flyway:
    enabled: true
    locations: classpath:db/migration
    schemas: [ingestion]

  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: ${JWT_ISSUER_URI:http://localhost:9093}
          jwk-set-uri: ${JWT_JWK_SET_URI:http://localhost:9093/.well-known/jwks.json}
      client:
        registration:
          ingestion-ms-client:
            client-id: ${ingestion_client_id:ingestion-ms-client}
            client-secret: ${ingestion_client_secret:RespectTheHangover}
            authorization-grant-type: client_credentials
            scope: service:audit,service:internal
        provider:
          ingestion-ms-client:
            token-uri: ${identity-ms.base-url}/oauth2/token

  jackson:
    serialization:
      write-dates-as-timestamps: false
    default-property-inclusion: non_null

  quartz:
    job-store-type: jdbc
    jdbc:
      initialize-schema: never
    properties:
      org.quartz.scheduler.instanceName: ingestion-scheduler
      org.quartz.scheduler.instanceId: AUTO
      org.quartz.jobStore.tablePrefix: core.QRTZ_
      org.quartz.jobStore.isClustered: true
      org.quartz.jobStore.clusterCheckinInterval: 20000
      org.quartz.jobStore.driverDelegateClass: org.quartz.impl.jdbcjobstore.PostgreSQLDelegate
      org.quartz.threadPool.threadCount: 5

jwt:
  public-key-path: "${jwt_public_key:-----BEGIN PUBLIC KEY-----MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA5DE42l3RNVrYKygAIzGdh3zhyozK6RRHvrsoQGokhRZieglqXmlmDfeX9wpGN0H8ze1s1wNYr3OvpRiQPVxo9X2KbOCTTGtbzUe4M1IdddEk2oVbbJtzzUygmsbVsJlvNfGGQNb58pPmRnrUCMJni3z4iFeXXOS0j4XLdO+OvN62IUvnQ8NnPE+EToeVp3SU57kRgWtpD9xstvUg7ezl8Q9+vpl/Az2lsWRogQDxnvW8yxrkHzrXoP1bddP9FvWgF3ol9A+8YVqkE32pbhpfgvZ+1acxLpo2UlqggZgQuIjuAV+aHsYg4m8FkmrTJHGBIHdDQ6mqMFUTHG6ISaEmxwIDAQAB-----END PUBLIC KEY-----}"
  issuer: ${JWT_ISSUER:http://localhost:9093}
  audience: ingestion-ms-client

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
      base-path: /actuator
  endpoint:
    health:
      show-details: when-authorized
      probes:
        enabled: true
    metrics:
      enabled: true
  health:
    readinessState:
      enabled: true
    livenessState:
      enabled: true
  metrics:
    tags:
      application: ${spring.application.name}

server:
  port: ${SERVER_PORT:9086}
  shutdown: graceful
  forward-headers-strategy: native

storage:
  type: ${STORAGE_TYPE:MINIO}
  minio:
    endpoint: ${MINIO_ENDPOINT:http://localhost:9000}
    access-key: ${MINIO_ACCESS_KEY:minioadmin}
    secret-key: ${MINIO_SECRET_KEY:minioadmin}
    bucket: ${MINIO_BUCKET:sovereign-rag}
  s3:
    region: ${AWS_REGION:us-east-1}
    access-key: ${AWS_ACCESS_KEY:}
    secret-key: ${AWS_SECRET_KEY:}
    bucket: ${S3_BUCKET:sovereign-rag}

ingestion:
  limits:
    max-file-size: ${INGESTION_MAX_FILE_SIZE:104857600}
    max-concurrent-jobs-per-organization: ${INGESTION_MAX_CONCURRENT_JOBS:5}
    max-batch-size: ${INGESTION_MAX_BATCH_SIZE:50}
    presigned-url-expiry-minutes: ${INGESTION_PRESIGNED_URL_EXPIRY:15}
    scrape-rate-limit-per-minute: ${INGESTION_SCRAPE_RATE_LIMIT:10}
    max-retries: ${INGESTION_MAX_RETRIES:3}
    job-timeout-minutes: ${INGESTION_JOB_TIMEOUT:60}
  storage:
    raw-bucket: ${INGESTION_RAW_BUCKET:sovereign-rag-raw}
    processed-bucket: ${INGESTION_PROCESSED_BUCKET:sovereign-rag-processed}
    temp-prefix: temp/
    uploads-prefix: uploads/
  scraping:
    user-agent: SovereignRAG-Bot/1.0
    timeout-seconds: 30
    max-content-length: 10485760
    respect-robots-txt: true
    delay-between-requests-ms: 1000
  queue:
    type: POSTGRES
    poll-interval-ms: ${INGESTION_QUEUE_POLL_INTERVAL:1000}
    batch-size: ${INGESTION_QUEUE_BATCH_SIZE:10}
    lock-timeout-minutes: ${INGESTION_QUEUE_LOCK_TIMEOUT:30}
    visibility-timeout-minutes: ${INGESTION_QUEUE_VISIBILITY_TIMEOUT:5}
  tiers:
    trial:
      storage-quota-bytes: ${INGESTION_TIER_TRIAL_STORAGE:104857600}
      max-concurrent-jobs: ${INGESTION_TIER_TRIAL_CONCURRENT:1}
      max-file-size: ${INGESTION_TIER_TRIAL_FILE_SIZE:10485760}
      priority: 0
      monthly-job-limit: ${INGESTION_TIER_TRIAL_MONTHLY:50}
    starter:
      storage-quota-bytes: ${INGESTION_TIER_STARTER_STORAGE:1073741824}
      max-concurrent-jobs: ${INGESTION_TIER_STARTER_CONCURRENT:3}
      max-file-size: ${INGESTION_TIER_STARTER_FILE_SIZE:52428800}
      priority: 1
      monthly-job-limit: ${INGESTION_TIER_STARTER_MONTHLY:500}
    professional:
      storage-quota-bytes: ${INGESTION_TIER_PRO_STORAGE:10737418240}
      max-concurrent-jobs: ${INGESTION_TIER_PRO_CONCURRENT:10}
      max-file-size: ${INGESTION_TIER_PRO_FILE_SIZE:104857600}
      priority: 2
      monthly-job-limit: ${INGESTION_TIER_PRO_MONTHLY:5000}
    enterprise:
      storage-quota-bytes: ${INGESTION_TIER_ENTERPRISE_STORAGE:9223372036854775807}
      max-concurrent-jobs: ${INGESTION_TIER_ENTERPRISE_CONCURRENT:50}
      max-file-size: ${INGESTION_TIER_ENTERPRISE_FILE_SIZE:524288000}
      priority: 3
      monthly-job-limit: ${INGESTION_TIER_ENTERPRISE_MONTHLY:2147483647}
  processing:
    chunk-size: 1000
    chunk-overlap: 200
    supported-mime-types:
      - application/pdf
      - application/msword
      - application/vnd.openxmlformats-officedocument.wordprocessingml.document
      - application/vnd.ms-excel
      - application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
      - application/vnd.ms-powerpoint
      - application/vnd.openxmlformats-officedocument.presentationml.presentation
      - text/plain
      - text/markdown
      - text/csv
      - text/html
      - application/json
      - application/xml
  embedding:
    model-name: ${EMBEDDING_MODEL:nomic-embed-text}
    ollama-base-url: ${OLLAMA_BASE_URL:http://localhost:11434}
    openai-api-key: ${OPENAI_API_KEY:}
    huggingface-api-key: ${HUGGINGFACE_API_KEY:}
    batch-size: ${EMBEDDING_BATCH_SIZE:32}
    dimension: ${EMBEDDING_DIMENSION:768}
    max-retries: 3
    retry-delay-ms: 1000
    table-prefix: kb_
    table-suffix: _embeddings
    pgvector:
      host: ${DB_HOST:localhost}
      port: ${DATABASE_PORT:5432}
      database: ${DATABASE_NAME:sovereignrag_master}
      user: ${sovereignrag_db_user:sovereignrag}
      password: ${sovereignrag_db_password:RespectTheHangover}
  remi:
    enabled: ${REMI_ENABLED:true}
    ollama-base-url: ${OLLAMA_BASE_URL:http://localhost:11434}
    model-name: ${REMI_MODEL:llama3.2:3b}
    timeout-seconds: ${REMI_TIMEOUT:60}
    async-enabled: ${REMI_ASYNC:true}
    batch-size: ${REMI_BATCH_SIZE:10}
    evaluation-delay-ms: ${REMI_DELAY:500}
    min-context-relevance-for-missing-knowledge: 0.3
    min-groundedness-for-hallucination: 0.5

sovereignrag:
  cors:
    allowed-origins: ${CORS_ALLOWED_ORIGINS:http://localhost:3000,http://localhost:5173}

identity-ms:
  base-url: ${IDENTITY_MS_BASE_URL:http://localhost:9083}

core-ms:
  base-url: ${CORE_MS_BASE_URL:http://localhost:9082}

audit-ms:
  base-url: ${AUDIT_MS_BASE_URL:http://localhost:9080}

regional-databases:
  default-region: ${DEFAULT_REGION:eu-west-1}
  regions:
    eu-west-1:
      url: "jdbc:postgresql://${DB_HOST:localhost}:${DATABASE_PORT:5432}/sovereignrag_master"
      username: "${sovereignrag_db_user:sovereignrag}"
      password: "${sovereignrag_db_password:RespectTheHangover}"
      read-replica-url: "jdbc:postgresql://${READ_REPLICA_DB_HOST:${DB_HOST:localhost}}:${READ_REPLICA_DATABASE_PORT:${DATABASE_PORT:5432}}/sovereignrag_master"
      max-pool-size: 10
      min-idle: 2
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000

springdoc:
  api-docs:
    path: /api-docs
  swagger-ui:
    path: /swagger-ui.html
    operationsSorter: method
