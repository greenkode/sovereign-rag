spring:
  config:
    import: "optional:configtree:/run/secrets/"
  application:
    name: audit

  datasource:
    main:
      url: "jdbc:postgresql://${DB_HOST:localhost}:${DATABASE_PORT:5432}/${DATABASE_NAME:sovereignrag}?ApplicationName=${spring.application.name}&currentSchema=audit&reWriteBatchedInserts=true&prepareThreshold=1&preferQueryMode=extended"
      username: "${sovereignrag_db_user:sovereignrag}"
      password: "${sovereignrag_db_password:RespectTheHangover}"
      driver-class-name: org.postgresql.Driver
      hikari:
        data-source-properties:
          cachePrepStmts: true
          prepStmtCacheSize: 250
          prepStmtCacheSqlLimit: 2048
          useServerPrepStmts: true
          useLocalSessionState: true
          rewriteBatchedStatements: true
          cacheResultSetMetadata: true
          cacheServerConfiguration: true
          elideSetAutoCommits: true
          maintainTimeStats: false
          application: ${spring.application.name}
          tcpKeepAlive: true
          socketTimeout: 30
          prepareThreshold: 1
          preferQueryMode: extended
        maximum-pool-size: 5
        minimum-idle: 2
        schema: audit
        connection-init-sql: SET search_path TO audit, public
        register-mbeans: false
        pool-name: "audit"
        connectionTimeout: 30000
        idleTimeout: 300000
        maxLifetime: 1800000
        leakDetectionThreshold: 60000
        validationTimeout: 5000
        connectionTestQuery: "SELECT 1"
        initializationFailTimeout: 30000
    read-replica:
      url: "jdbc:postgresql://${READ_REPLICA_DB_HOST:localhost}:${READ_REPLICA_DATABASE_PORT:5432}/${READ_REPLICA_DATABASE_NAME:sovereignrag_local}?ApplicationName=${spring.application.name}&currentSchema=audit&reWriteBatchedInserts=true"
      username: "${sovereignrag_db_user:sovereignrag}"
      password: "${sovereignrag_db_password:RespectTheHangover}"
      driver-class-name: org.postgresql.Driver
      hikari:
        data-source-properties:
          cachePrepStmts: true
          prepStmtCacheSize: 200
          prepStmtCacheSqlLimit: 2048
          useServerPrepStmts: true
          useLocalSessionState: true
          rewriteBatchedStatements: true
          cacheResultSetMetadata: true
          cacheServerConfiguration: true
          elideSetAutoCommits: true
          maintainTimeStats: false
          application: ${spring.application.name}
          tcpKeepAlive: true
          socketTimeout: 30
        maximum-pool-size: 3
        minimum-idle: 1
        schema: audit
        connection-init-sql: SET search_path TO audit, public
        register-mbeans: false
        pool-name: "audit-replica"
        connectionTimeout: 30000
        idleTimeout: 300000
        maxLifetime: 1800000
        leakDetectionThreshold: 60000
        validationTimeout: 5000
        connectionTestQuery: "SELECT 1"
        initializationFailTimeout: 30000
  jpa:
    hibernate:
      ddl-auto: validate

  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: ${JWT_ISSUER_URI:http://localhost:9093}
          jwk-set-uri: ${JWT_JWK_SET_URI:http://localhost:9093/.well-known/jwks.json}

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
      base-path: /actuator
  endpoint:
    health:
      show-details: when-authorized
      probes:
        enabled: true
    metrics:
      enabled: true
  health:
    readinessState:
      enabled: true
    livenessState:
      enabled: true
  metrics:
    tags:
      application: ${spring.application.name}

application:
  services:
    accounting:
      base-url: ${ACCOUNTING_BASE_URL:http://localhost:7070}

server:
  port: ${SERVER_PORT:9080}
  shutdown: graceful
  forward-headers-strategy: native

jwt:
  public-key-path: "${jwt_public_key:-----BEGIN PUBLIC KEY-----MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA5DE42l3RNVrYKygAIzGdh3zhyozK6RRHvrsoQGokhRZieglqXmlmDfeX9wpGN0H8ze1s1wNYr3OvpRiQPVxo9X2KbOCTTGtbzUe4M1IdddEk2oVbbJtzzUygmsbVsJlvNfGGQNb58pPmRnrUCMJni3z4iFeXXOS0j4XLdO+OvN62IUvnQ8NnPE+EToeVp3SU57kRgWtpD9xstvUg7ezl8Q9+vpl/Az2lsWRogQDxnvW8yxrkHzrXoP1bddP9FvWgF3ol9A+8YVqkE32pbhpfgvZ+1acxLpo2UlqggZgQuIjuAV+aHsYg4m8FkmrTJHGBIHdDQ6mqMFUTHG6ISaEmxwIDAQAB-----END PUBLIC KEY-----}"
  issuer: ${JWT_ISSUER:http://localhost:9093}
  audience: audit-ms-client